<?php
include("../includes/connect.php"); 

$sql = "SELECT dh.IdDonHang, dh.MaKH, dh.NgayDat, dh.NgayGiaoDuKien, dh.DiaChiGiaoHang, dh.TrangThai,
        ct.IdSanPham, ct.SoLuong, ct.DonGia, sp.TenSanPham
        FROM tbl_donhang dh 
        INNER JOIN tbl_chitietdonhang ct ON dh.IdDonHang = ct.IdDonHang
		INNER JOIN tbl_sanpham sp ON ct.IdSanPham = sp.IdSanPham
        ORDER BY dh.IdDonHang";

$danhsach = $connect->query($sql); 

if (!$danhsach) { 
    die("Kh√¥ng th·ªÉ th·ª±c hi·ªán c√¢u l·ªánh SQL: ". $connect->error); 
}

$donhangs = [];
while ($row = $danhsach->fetch_assoc()) {
    $id = $row['IdDonHang'];
    if (!isset($donhangs[$id])) {
        $donhangs[$id] = [
            'MaKH' => $row['MaKH'],
            'NgayDat' => $row['NgayDat'],
            'NgayGiaoDuKien' => $row['NgayGiaoDuKien'],
            'DiaChiGiaoHang' => $row['DiaChiGiaoHang'],
            'TrangThai' => $row['TrangThai'],
            'Chitiet' => []
        ];
    }
    $donhangs[$id]['Chitiet'][] = [
        'TenSanPham' => $row['TenSanPham'],
        'SoLuong' => $row['SoLuong'],
        'DonGia' => $row['DonGia'],
    ];
}
?>

<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8" />
    <title>Danh s√°ch ƒë∆°n h√†ng</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
</head>
<body class="bg-light">
    <div class="container py-5">
        <h1 class="mb-4 text-primary">üìã Danh s√°ch ƒë∆°n h√†ng v√† chi ti·∫øt</h1>

        <?php if (empty($donhangs)) : ?>
            <div class="alert alert-info">Ch∆∞a c√≥ ƒë∆°n h√†ng n√†o.</div>
        <?php else: ?>
            <?php foreach ($donhangs as $idDonHang => $donhang) : ?>
                <div class="card mb-4 shadow-sm">
                    <div class="card-header bg-primary text-white">
                        <strong>ƒê∆°n h√†ng #<?= htmlspecialchars($idDonHang) ?></strong>
                        <span class="float-end">
                            Tr·∫°ng th√°i: 
                            <?php
                                switch ($donhang['TrangThai']) {
                                    case 0: echo '<span class="badge bg-secondary">Ch·ªù x·ª≠ l√Ω</span>'; break;
                                    case 1: echo '<span class="badge bg-warning">ƒêang giao</span>'; break;
                                    case 2: echo '<span class="badge bg-success">Ho√†n th√†nh</span>'; break;
                                    case 3: echo '<span class="badge bg-danger">ƒê√£ h·ªßy</span>'; break;
                                    default: echo '<span class="badge bg-info">Kh√¥ng x√°c ƒë·ªãnh</span>';
                                }
                            ?>
                        </span>
                    </div>
                    <div class="card-body">
                        <p><strong>Kh√°ch h√†ng:</strong> <?= htmlspecialchars($donhang['MaKH']) ?></p>
                        <p><strong>Ng√†y ƒë·∫∑t:</strong> <?= htmlspecialchars($donhang['NgayDat']) ?></p>
                        <p><strong>D·ª± ki·∫øn giao:</strong> <?= htmlspecialchars($donhang['NgayGiaoDuKien']) ?></p>
                        <p><strong>ƒê·ªãa ch·ªâ giao h√†ng:</strong> <?= htmlspecialchars($donhang['DiaChiGiaoHang']) ?></p>

                        <h5>Chi ti·∫øt s·∫£n ph·∫©m:</h5>
                        <table class="table table-bordered table-striped">
                            <thead class="table-light">
                                <tr>
                                    <th>ID S·∫£n ph·∫©m</th>
                                    <th>S·ªë l∆∞·ª£ng</th>
                                    <th>ƒê∆°n gi√°</th>
                                    <th>Th√†nh ti·ªÅn</th>
                                </tr>
                            </thead>
                            <tbody>
                                <?php 
                                $tong = 0;
                                foreach ($donhang['Chitiet'] as $ct): 
                                    $thanhtien = $ct['SoLuong'] * $ct['DonGia'];
                                    $tong += $thanhtien;
                                ?>
                                    <tr>
                                        <td><?= htmlspecialchars($ct['TenSanPham']) ?></td>
                                        <td><?= htmlspecialchars($ct['SoLuong']) ?></td>
                                        <td><?= number_format($ct['DonGia'], 0, ',', '.') ?>‚Ç´</td>
                                        <td><?= number_format($thanhtien, 0, ',', '.') ?>‚Ç´</td>
                                    </tr>
                                <?php endforeach; ?>
                                <tr class="fw-bold">
                                    <td colspan="3" class="text-end">T·ªïng c·ªông:</td>
                                    <td><?= number_format($tong, 0, ',', '.') ?>‚Ç´</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            <?php endforeach; ?>
        <?php endif; ?>
    </div>
</body>
</html>
